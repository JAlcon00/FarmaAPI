name: CI - Tests y ValidaciÃ³n

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: ðŸ§ª Tests y Cobertura
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_test_password
          MYSQL_DATABASE: farmacontrol_test
          MYSQL_USER: farmacontrol_test
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: ðŸ” Verificar estructura del proyecto
        run: |
          echo "ðŸ“‚ Project structure:"
          ls -la
          echo "ðŸ“„ POM file exists:"
          test -f pom.xml && echo "âœ… pom.xml found" || echo "âŒ pom.xml not found"

      - name: ðŸ—ï¸ Compilar proyecto
        run: mvn clean compile -DskipTests

      - name: ðŸ§ª Ejecutar tests
        env:
          DB_HOST: localhost
          DB_PORT: 3306
          DB_NAME: farmacontrol_test
          DB_USER: farmacontrol_test
          DB_PASSWORD: test_password
          JWT_SECRET: test_secret_key_for_ci_pipeline_12345678901234567890
          JWT_EXPIRATION: 86400000
          JWT_REFRESH_EXPIRATION: 604800000
        run: mvn test

      - name: ðŸ“Š Generar reporte de cobertura
        run: mvn jacoco:report

      - name: ðŸ“¤ Subir reporte de cobertura
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco/
          retention-days: 30

      - name: ðŸ“ˆ Mostrar resumen de cobertura
        run: |
          if [ -f target/site/jacoco/index.html ]; then
            echo "âœ… Coverage report generated"
            echo "ðŸ“Š Coverage summary:"
            grep -o '[0-9]\+%' target/site/jacoco/index.html | head -5 || echo "Unable to parse coverage"
          fi

  lint:
    name: ðŸ” AnÃ¡lisis de cÃ³digo
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: ðŸ” Maven verify
        run: mvn verify -DskipTests

  security:
    name: ðŸ”’ AnÃ¡lisis de seguridad
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”’ Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ðŸ“¤ Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  docker:
    name: ðŸ³ Validar Docker build
    runs-on: ubuntu-latest
    needs: [test]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: ðŸ—ï¸ Compilar JAR
        run: mvn clean package -DskipTests

      - name: ðŸ³ Build Docker image
        run: docker build -f docker/Dockerfile -t farmacontrol-api:test .

      - name: âœ… Verificar imagen
        run: |
          docker images | grep farmacontrol-api
          echo "âœ… Docker image built successfully"

  summary:
    name: âœ… Resumen de CI
    runs-on: ubuntu-latest
    needs: [test, lint, security, docker]
    if: always()
    
    steps:
      - name: ðŸ“Š CI Summary
        run: |
          echo "## ðŸŽ¯ CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª Tests: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Lint: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Security: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ Docker: Passed" >> $GITHUB_STEP_SUMMARY
